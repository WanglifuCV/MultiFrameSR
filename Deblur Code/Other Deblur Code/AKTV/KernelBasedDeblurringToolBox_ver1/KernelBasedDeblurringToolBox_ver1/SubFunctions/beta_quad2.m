function [z, zx, zy, zxx, zxy, zyy] = beta_quad2

global s11;
global s12;
global s22;
global s13;
global s23;
global s33;
global f1;
global f2;
global f3;

[N M] = size(s11);

% compute image
S12 = zeros(N, M, 2);
S22 = zeros(N, M, 4);
S13 = zeros(N, M, 3);
S33 = zeros(N, M, 9);
s22inv = inv22(s22);
s33inv = inv33(s33);
tmp1 = s33inv(:,:,1) .* s23(:,:,1) + s33inv(:,:,4) .* s23(:,:,3) + s33inv(:,:,7) .* s23(:,:,5);
tmp2 = s33inv(:,:,2) .* s23(:,:,1) + s33inv(:,:,5) .* s23(:,:,3) + s33inv(:,:,8) .* s23(:,:,5);
tmp3 = s33inv(:,:,3) .* s23(:,:,1) + s33inv(:,:,6) .* s23(:,:,3) + s33inv(:,:,9) .* s23(:,:,5);
tmp4 = s33inv(:,:,1) .* s23(:,:,2) + s33inv(:,:,4) .* s23(:,:,4) + s33inv(:,:,7) .* s23(:,:,6);
tmp5 = s33inv(:,:,2) .* s23(:,:,2) + s33inv(:,:,5) .* s23(:,:,4) + s33inv(:,:,8) .* s23(:,:,6);
tmp6 = s33inv(:,:,3) .* s23(:,:,2) + s33inv(:,:,6) .* s23(:,:,4) + s33inv(:,:,9) .* s23(:,:,6);
S12(:,:,1) = s12(:,:,1) - (s13(:,:,1) .* tmp1 + s13(:,:,2) .* tmp2 + s13(:,:,3) .* tmp3);
S12(:,:,2) = s12(:,:,2) - (s13(:,:,1) .* tmp4 + s13(:,:,2) .* tmp5 + s13(:,:,3) .* tmp6);
S22(:,:,1) = s22(:,:,1) - (s23(:,:,1) .* tmp1 + s23(:,:,3) .* tmp2 + s23(:,:,5) .* tmp3);
S22(:,:,2) = s22(:,:,2) - (s23(:,:,2) .* tmp1 + s23(:,:,4) .* tmp2 + s23(:,:,6) .* tmp3);
S22(:,:,3) = s22(:,:,3) - (s23(:,:,1) .* tmp4 + s23(:,:,3) .* tmp5 + s23(:,:,5) .* tmp6);
S22(:,:,4) = s22(:,:,4) - (s23(:,:,2) .* tmp4 + s23(:,:,4) .* tmp5 + s23(:,:,6) .* tmp6);
tmp1 = s22inv(:,:,1) .* s23(:,:,1) + s22inv(:,:,3) .* s23(:,:,2);
tmp2 = s22inv(:,:,2) .* s23(:,:,1) + s22inv(:,:,4) .* s23(:,:,2);
tmp3 = s22inv(:,:,1) .* s23(:,:,3) + s22inv(:,:,3) .* s23(:,:,4);
tmp4 = s22inv(:,:,2) .* s23(:,:,3) + s22inv(:,:,4) .* s23(:,:,4);
tmp5 = s22inv(:,:,1) .* s23(:,:,5) + s22inv(:,:,3) .* s23(:,:,6);
tmp6 = s22inv(:,:,2) .* s23(:,:,5) + s22inv(:,:,4) .* s23(:,:,6);
S13(:,:,1) = s13(:,:,1) - (s12(:,:,1) .* tmp1 + s12(:,:,2) .* tmp2);
S13(:,:,2) = s13(:,:,2) - (s12(:,:,1) .* tmp3 + s12(:,:,2) .* tmp4);
S13(:,:,3) = s13(:,:,3) - (s12(:,:,1) .* tmp5 + s12(:,:,2) .* tmp6);
S33(:,:,1) = s33(:,:,1) - (s23(:,:,1) .* tmp1 + s23(:,:,2) .* tmp2);
S33(:,:,2) = s33(:,:,2) - (s23(:,:,3) .* tmp1 + s23(:,:,4) .* tmp2);
S33(:,:,3) = s33(:,:,3) - (s23(:,:,5) .* tmp1 + s23(:,:,6) .* tmp2);
S33(:,:,4) = s33(:,:,4) - (s23(:,:,1) .* tmp3 + s23(:,:,2) .* tmp4);
S33(:,:,5) = s33(:,:,5) - (s23(:,:,3) .* tmp3 + s23(:,:,4) .* tmp4);
S33(:,:,6) = s33(:,:,6) - (s23(:,:,5) .* tmp3 + s23(:,:,6) .* tmp4);
S33(:,:,7) = s33(:,:,7) - (s23(:,:,1) .* tmp5 + s23(:,:,2) .* tmp6);
S33(:,:,8) = s33(:,:,8) - (s23(:,:,3) .* tmp5 + s23(:,:,4) .* tmp6);
S33(:,:,9) = s33(:,:,9) - (s23(:,:,5) .* tmp5 + s23(:,:,6) .* tmp6);
S22inv = inv22(S22);
S33inv = inv33(S33);
S12S22inv = zeros(N, M, 2);
S13S33inv = zeros(N, M, 3);
S12S22inv(:,:,1) = S12(:,:,1) .* S22inv(:,:,1) + S12(:,:,2) .* S22inv(:,:,2);
S12S22inv(:,:,2) = S12(:,:,1) .* S22inv(:,:,3) + S12(:,:,2) .* S22inv(:,:,4);
S13S33inv(:,:,1) = S13(:,:,1) .* S33inv(:,:,1) + S13(:,:,2) .* S33inv(:,:,2) + S13(:,:,3) .* S33inv(:,:,3);
S13S33inv(:,:,2) = S13(:,:,1) .* S33inv(:,:,4) + S13(:,:,2) .* S33inv(:,:,5) + S13(:,:,3) .* S33inv(:,:,6);
S13S33inv(:,:,3) = S13(:,:,1) .* S33inv(:,:,7) + S13(:,:,2) .* S33inv(:,:,8) + S13(:,:,3) .* S33inv(:,:,9);
denom = s11 - (S12S22inv(:,:,1) .* s12(:,:,1) + S12S22inv(:,:,2) .* s12(:,:,2))...
            - (S13S33inv(:,:,1) .* s13(:,:,1) + S13S33inv(:,:,2) .* s13(:,:,2) + S13S33inv(:,:,3) .* s13(:,:,3));
z = (f1 - (S12S22inv(:,:,1) .* f2(:,:,1) + S12S22inv(:,:,2) .* f2(:,:,2))...
       - (S13S33inv(:,:,1) .* f3(:,:,1) + S13S33inv(:,:,2) .* f3(:,:,2) + S13S33inv(:,:,3) .* f3(:,:,3))) ./ (denom + (denom == 0));

% compute the first derivatives
S11 = zeros(N, M);
S21 = zeros(N, M, 2);
S23 = zeros(N, M, 6);
S33 = zeros(N, M, 9);
ES  = zeros(N, M, 4);
S21S11inv = zeros(N, M, 2);
S23S33inv = zeros(N, M, 6);

tmp1 = s33inv(:,:,1) .* s13(:,:,1) + s33inv(:,:,4) .* s13(:,:,2) + s33inv(:,:,7) .* s13(:,:,3);
tmp2 = s33inv(:,:,2) .* s13(:,:,1) + s33inv(:,:,5) .* s13(:,:,2) + s33inv(:,:,8) .* s13(:,:,3);
tmp3 = s33inv(:,:,3) .* s13(:,:,1) + s33inv(:,:,6) .* s13(:,:,2) + s33inv(:,:,9) .* s13(:,:,3);
S11 = s11 - (s13(:,:,1) .* tmp1 + s13(:,:,2) .* tmp2 + s13(:,:,3) .* tmp3);
S21(:,:,1) = s12(:,:,1) - (s23(:,:,1) .* tmp1 + s23(:,:,3) .* tmp2 + s23(:,:,5) .* tmp3);
S21(:,:,2) = s12(:,:,2) - (s23(:,:,2) .* tmp1 + s23(:,:,4) .* tmp2 + s23(:,:,6) .* tmp3);
tmp1 = s13(:,:,1) ./ s11;
tmp2 = s13(:,:,2) ./ s11;
tmp3 = s13(:,:,3) ./ s11;
S23(:,:,1) = s23(:,:,1) - s12(:,:,1) .* tmp1;
S23(:,:,2) = s23(:,:,2) - s12(:,:,2) .* tmp1;
S23(:,:,3) = s23(:,:,3) - s12(:,:,1) .* tmp2;
S23(:,:,4) = s23(:,:,4) - s12(:,:,2) .* tmp2;
S23(:,:,5) = s23(:,:,5) - s12(:,:,1) .* tmp3;
S23(:,:,6) = s23(:,:,6) - s12(:,:,2) .* tmp3;
S33(:,:,1) = s33(:,:,1) - s13(:,:,1) .* tmp1;
S33(:,:,2) = s33(:,:,2) - s13(:,:,2) .* tmp1;
S33(:,:,3) = s33(:,:,3) - s13(:,:,3) .* tmp1;
S33(:,:,4) = s33(:,:,4) - s13(:,:,1) .* tmp2;
S33(:,:,5) = s33(:,:,5) - s13(:,:,2) .* tmp2;
S33(:,:,6) = s33(:,:,6) - s13(:,:,3) .* tmp2;
S33(:,:,7) = s33(:,:,7) - s13(:,:,1) .* tmp3;
S33(:,:,8) = s33(:,:,8) - s13(:,:,2) .* tmp3;
S33(:,:,9) = s33(:,:,9) - s13(:,:,3) .* tmp3;
S33inv = inv33(S33);
S21S11inv(:,:,1) = S21(:,:,1) ./ S11;
S21S11inv(:,:,2) = S21(:,:,2) ./ S11;
S23S33inv(:,:,1) = S23(:,:,1) .* S33inv(:,:,1) + S23(:,:,3) .* S33inv(:,:,2) + S23(:,:,5) .* S33inv(:,:,3);
S23S33inv(:,:,2) = S23(:,:,2) .* S33inv(:,:,1) + S23(:,:,4) .* S33inv(:,:,2) + S23(:,:,6) .* S33inv(:,:,3);
S23S33inv(:,:,3) = S23(:,:,1) .* S33inv(:,:,4) + S23(:,:,3) .* S33inv(:,:,5) + S23(:,:,5) .* S33inv(:,:,6);
S23S33inv(:,:,4) = S23(:,:,2) .* S33inv(:,:,4) + S23(:,:,4) .* S33inv(:,:,5) + S23(:,:,6) .* S33inv(:,:,6);
S23S33inv(:,:,5) = S23(:,:,1) .* S33inv(:,:,7) + S23(:,:,3) .* S33inv(:,:,8) + S23(:,:,5) .* S33inv(:,:,9);
S23S33inv(:,:,6) = S23(:,:,2) .* S33inv(:,:,7) + S23(:,:,4) .* S33inv(:,:,8) + S23(:,:,6) .* S33inv(:,:,9);
ES(:,:,1) = s22(:,:,1) - S21S11inv(:,:,1) .* s12(:,:,1) - (S23S33inv(:,:,1) .* S23(:,:,1) + S23S33inv(:,:,3) .* S23(:,:,3) + S23S33inv(:,:,5) .* S23(:,:,5));
ES(:,:,2) = s22(:,:,2) - S21S11inv(:,:,2) .* s12(:,:,1) - (S23S33inv(:,:,2) .* S23(:,:,1) + S23S33inv(:,:,4) .* S23(:,:,3) + S23S33inv(:,:,6) .* S23(:,:,5));
ES(:,:,3) = s22(:,:,3) - S21S11inv(:,:,1) .* s12(:,:,2) - (S23S33inv(:,:,1) .* S23(:,:,2) + S23S33inv(:,:,3) .* S23(:,:,4) + S23S33inv(:,:,5) .* S23(:,:,6));
ES(:,:,4) = s22(:,:,4) - S21S11inv(:,:,2) .* s12(:,:,2) - (S23S33inv(:,:,2) .* S23(:,:,2) + S23S33inv(:,:,4) .* S23(:,:,4) + S23S33inv(:,:,6) .* S23(:,:,6));
ESinv = inv22(ES);
tmp1 = - S21S11inv(:,:,1) .* f1 + f2(:,:,1) - (S23S33inv(:,:,1) .* f3(:,:,1) + S23S33inv(:,:,3) .* f3(:,:,2) + S23S33inv(:,:,5) .* f3(:,:,3));
tmp2 = - S21S11inv(:,:,2) .* f1 + f2(:,:,2) - (S23S33inv(:,:,2) .* f3(:,:,1) + S23S33inv(:,:,4) .* f3(:,:,2) + S23S33inv(:,:,6) .* f3(:,:,3));
zx = ESinv(:,:,1) .* tmp1 + ESinv(:,:,3) .* tmp2;
zy = ESinv(:,:,2) .* tmp1 + ESinv(:,:,4) .* tmp2;

% compute the second derivatives
clear S21;
clear S23;
clear S33;
clear S21S11inv;
clear S23S33inv;

S11 = zeros(N, M);
S22 = zeros(N, M, 4);
S31 = zeros(N, M, 3);
S32 = zeros(N, M, 6);
S31S11inv = zeros(N, M, 3);
S32S22inv = zeros(N, M, 6);
tmp1 = s22inv(:,:,1) .* s12(:,:,1) + s22inv(:,:,3) .* s12(:,:,2);
tmp2 = s22inv(:,:,2) .* s12(:,:,1) + s22inv(:,:,4) .* s12(:,:,2);
S11 = s11 - s12(:,:,1) .* tmp1 - s12(:,:,2) .* tmp2;
S31(:,:,1) = s13(:,:,1) - s23(:,:,1) .* tmp1 - s23(:,:,2) .* tmp2;
S31(:,:,2) = s13(:,:,2) - s23(:,:,3) .* tmp1 - s23(:,:,4) .* tmp2;
S31(:,:,3) = s13(:,:,3) - s23(:,:,5) .* tmp1 - s23(:,:,6) .* tmp2;
tmp1 = s12(:,:,1) ./ s11;
tmp2 = s12(:,:,2) ./ s11;
S22(:,:,1) = s22(:,:,1) - s12(:,:,1) .* tmp1;
S22(:,:,2) = s22(:,:,2) - s12(:,:,2) .* tmp1;
S22(:,:,3) = s22(:,:,3) - s12(:,:,1) .* tmp2;
S22(:,:,4) = s22(:,:,4) - s12(:,:,2) .* tmp2;
S32(:,:,1) = s23(:,:,1) - s13(:,:,1) .* tmp1;
S32(:,:,2) = s23(:,:,3) - s13(:,:,2) .* tmp1;
S32(:,:,3) = s23(:,:,5) - s13(:,:,3) .* tmp1;
S32(:,:,4) = s23(:,:,2) - s13(:,:,1) .* tmp2;
S32(:,:,5) = s23(:,:,4) - s13(:,:,2) .* tmp2;
S32(:,:,6) = s23(:,:,6) - s13(:,:,3) .* tmp2;
S22inv = inv22(S22);
S31S11inv(:,:,1) = S31(:,:,1) ./ S11;
S31S11inv(:,:,2) = S31(:,:,2) ./ S11;
S31S11inv(:,:,3) = S31(:,:,3) ./ S11;
S32S22inv(:,:,1) = S32(:,:,1) .* S22inv(:,:,1) + S32(:,:,4) .* S22inv(:,:,2);
S32S22inv(:,:,2) = S32(:,:,2) .* S22inv(:,:,1) + S32(:,:,5) .* S22inv(:,:,2);
S32S22inv(:,:,3) = S32(:,:,3) .* S22inv(:,:,1) + S32(:,:,6) .* S22inv(:,:,2);
S32S22inv(:,:,4) = S32(:,:,1) .* S22inv(:,:,3) + S32(:,:,4) .* S22inv(:,:,4);
S32S22inv(:,:,5) = S32(:,:,2) .* S22inv(:,:,3) + S32(:,:,5) .* S22inv(:,:,4);
S32S22inv(:,:,6) = S32(:,:,3) .* S22inv(:,:,3) + S32(:,:,6) .* S22inv(:,:,4);
clear S22inv;
clear S11;
clear S31;
clear S32;
clear S22;
ES = zeros(N, M, 9);
ES(:,:,1) = s33(:,:,1) - S31S11inv(:,:,1) .* s13(:,:,1) - S32S22inv(:,:,1) .* s23(:,:,1) - S32S22inv(:,:,4) .* s23(:,:,2);
ES(:,:,2) = s33(:,:,2) - S31S11inv(:,:,2) .* s13(:,:,1) - S32S22inv(:,:,2) .* s23(:,:,1) - S32S22inv(:,:,5) .* s23(:,:,2);
ES(:,:,3) = s33(:,:,3) - S31S11inv(:,:,3) .* s13(:,:,1) - S32S22inv(:,:,3) .* s23(:,:,1) - S32S22inv(:,:,6) .* s23(:,:,2);
ES(:,:,4) = s33(:,:,4) - S31S11inv(:,:,1) .* s13(:,:,2) - S32S22inv(:,:,1) .* s23(:,:,3) - S32S22inv(:,:,4) .* s23(:,:,4);
ES(:,:,5) = s33(:,:,5) - S31S11inv(:,:,2) .* s13(:,:,2) - S32S22inv(:,:,2) .* s23(:,:,3) - S32S22inv(:,:,5) .* s23(:,:,4);
ES(:,:,6) = s33(:,:,6) - S31S11inv(:,:,3) .* s13(:,:,2) - S32S22inv(:,:,3) .* s23(:,:,3) - S32S22inv(:,:,6) .* s23(:,:,4);
ES(:,:,7) = s33(:,:,7) - S31S11inv(:,:,1) .* s13(:,:,3) - S32S22inv(:,:,1) .* s23(:,:,5) - S32S22inv(:,:,4) .* s23(:,:,6);
ES(:,:,8) = s33(:,:,8) - S31S11inv(:,:,2) .* s13(:,:,3) - S32S22inv(:,:,2) .* s23(:,:,5) - S32S22inv(:,:,5) .* s23(:,:,6);
ES(:,:,9) = s33(:,:,9) - S31S11inv(:,:,3) .* s13(:,:,3) - S32S22inv(:,:,3) .* s23(:,:,5) - S32S22inv(:,:,6) .* s23(:,:,6);
ES = inv33(ES);
tmp1 = - S31S11inv(:,:,1) .* f1 - S32S22inv(:,:,1) .* f2(:,:,1) - S32S22inv(:,:,4) .* f2(:,:,2) + f3(:,:,1);
tmp2 = - S31S11inv(:,:,2) .* f1 - S32S22inv(:,:,2) .* f2(:,:,1) - S32S22inv(:,:,5) .* f2(:,:,2) + f3(:,:,2);
tmp3 = - S31S11inv(:,:,3) .* f1 - S32S22inv(:,:,3) .* f2(:,:,1) - S32S22inv(:,:,6) .* f2(:,:,2) + f3(:,:,3);
zxx = ES(:,:,1) .* tmp1 + ES(:,:,4) .* tmp2 + ES(:,:,7) .* tmp3;
zxy = ES(:,:,2) .* tmp1 + ES(:,:,5) .* tmp2 + ES(:,:,8) .* tmp3;
zyy = ES(:,:,3) .* tmp1 + ES(:,:,6) .* tmp2 + ES(:,:,9) .* tmp3;
